<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatConnect - Modern Messaging</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Dark Mode Variables */
        :root {
            --bg-primary: #f0f4f8;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f7fafc;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --border-color: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        .dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        body {
            box-sizing: border-box;
            transition: background-color 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }
        
        .message-animation {
            animation: slideIn 0.3s ease-out;
        }
        
        .typing-indicator {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .chat-scroll {
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) var(--bg-tertiary);
        }
        
        .chat-scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-scroll::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }
        
        .chat-scroll::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        .transition-theme {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }
        
        .emoji-btn {
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            border-radius: 8px;
            transition: transform 0.2s, background-color 0.2s;
            background: transparent;
            border: none;
        }
        
        .emoji-btn:hover {
            transform: scale(1.2);
            background-color: var(--bg-tertiary);
        }
        
        .online-indicator {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        
        .message-bubble {
            position: relative;
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 4px;
            word-wrap: break-word;
        }
        
        .message-bubble.user {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border-bottom-right-radius: 4px;
            margin-left: auto;
        }
        
        .message-bubble.other {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }
        
        .message-bubble.system {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: var(--text-primary);
            border-radius: 8px;
            text-align: center;
            max-width: 90%;
            margin: 0 auto;
        }
        
        .message-sender {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.9;
        }
        
        .message-time {
            font-size: 0.7rem;
            margin-top: 4px;
            text-align: right;
            opacity: 0.8;
        }
    </style>
</head>
<body class="h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Login Screen -->
    <div id="login-screen" class="w-full h-full flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <div class="text-5xl mb-4">
                    ðŸ’¬
                </div>
                <h1 id="app-title-login" class="text-3xl font-bold mb-2 dark:text-white">ChatConnect</h1>
                <p id="welcome-msg" class="text-gray-600 dark:text-gray-300">Connect with friends instantly</p>
            </div>
            
            <!-- Login Form -->
            <div id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                    <input type="email" id="email" required 
                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                           placeholder="your@email.com">
                </div>
                
                <div id="login-fields">
                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                    <input type="password" id="password" required 
                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                           placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                
                <div id="register-fields" class="hidden">
                    <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
                    <input type="text" id="username" 
                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                           placeholder="Choose a username">
                </div>
                
                <button id="auth-button" onclick="login()" 
                        class="w-full py-3 rounded-lg font-semibold transition-all transform hover:scale-105 bg-blue-500 hover:bg-blue-600 text-white">
                    Sign In
                </button>
                
                <div class="flex items-center justify-between">
                    <button type="button" id="switch-auth" onclick="toggleAuthForm()" 
                            class="text-sm text-blue-500 hover:text-blue-600 dark:text-blue-400">
                        Create an account
                    </button>
                    
                    <button type="button" id="reset-password" onclick="resetPassword()" 
                            class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400">
                        Forgot password?
                    </button>
                </div>
            </div>
            
            <!-- Firebase Status -->
            <div id="firebase-status" class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                <p class="text-xs text-gray-600 dark:text-gray-300 mb-2">
                    âœ… <strong>Firebase Connected</strong>
                </p>
                <p class="text-xs text-gray-600 dark:text-gray-300">
                    Real-time messaging is enabled. Messages are secure and private.
                </p>
            </div>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div id="chat-screen" class="hidden w-full h-full flex flex-col">
        <!-- Header -->
        <header class="flex-shrink-0 px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-white dark:bg-gray-800">
            <div class="flex items-center space-x-3">
                <div class="text-3xl">
                    ðŸ’¬
                </div>
                <div>
                    <h1 id="app-title-header" class="text-xl font-bold text-gray-900 dark:text-white">ChatConnect</h1>
                    <div class="flex items-center space-x-1">
                        <span class="online-indicator"></span>
                        <p class="text-xs text-gray-600 dark:text-gray-300" id="online-status">Online</p>
                        <span class="text-xs text-gray-500 dark:text-gray-400 ml-2" id="user-count">â€¢ 1 online</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="theme-toggle" onclick="toggleDarkMode()" 
                        class="p-2 rounded-lg transition-all hover:scale-110 bg-gray-100 dark:bg-gray-700">
                    <span id="theme-icon" class="text-2xl">ðŸŒ™</span>
                </button>
                <button id="logout-button" onclick="logout()" 
                        class="px-4 py-2 text-sm font-medium rounded-lg transition-all hover:scale-105 bg-red-500 hover:bg-red-600 text-white">
                    Logout
                </button>
            </div>
        </header>

        <!-- Chat Area -->
        <div class="flex-1 overflow-hidden flex flex-col">
            <!-- Messages Container -->
            <div id="messages-container" class="flex-1 overflow-auto chat-scroll p-6 space-y-4 bg-gray-50 dark:bg-gray-900">
                <div class="text-center text-gray-500 dark:text-gray-400 text-sm py-4">
                    <p>ðŸ‘‹ Welcome to ChatConnect! Start messaging below.</p>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="typing-indicator" class="hidden px-6 py-2 text-sm text-gray-500 dark:text-gray-400 typing-indicator">
                <div class="flex items-center space-x-2">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                    </div>
                    <span id="typing-text">Someone is typing...</span>
                </div>
            </div>

            <!-- Message Input -->
            <div class="flex-shrink-0 p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                <!-- Emoji Picker -->
                <div id="emoji-picker" class="hidden mb-3 p-3 border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800">
                    <div class="emoji-picker" id="emoji-grid"></div>
                </div>

                <form id="message-form" class="flex space-x-2" onsubmit="sendMessage(); return false;">
                    <button type="button" id="emoji-toggle" onclick="toggleEmojiPicker()" 
                            class="px-3 py-3 rounded-full font-semibold transition-all transform hover:scale-110 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300"
                            title="Add Emoji">
                        ðŸ˜Š
                    </button>
                    
                    <input type="text" id="message-input" required placeholder="Type a message..." 
                           class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                           oninput="handleTyping()">
                    
                    <button type="submit" 
                            class="px-6 py-3 rounded-full font-semibold transition-all transform hover:scale-105 bg-blue-500 hover:bg-blue-600 text-white">
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ========== FIREBASE CONFIGURATION ==========
        const firebaseConfig = {
            apiKey: "AIzaSyC3z-0TFNvgAwGIxis--XAzPXjP30DeCe8",
            authDomain: "maryum-f169b.firebaseapp.com",
            databaseURL: "https://maryum-f169b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "maryum-f169b",
            storageBucket: "maryum-f169b.firebasestorage.app",
            messagingSenderId: "120896430100",
            appId: "1:120896430100:web:b4d139d1c2279721f2c701"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // ========== STATE MANAGEMENT ==========
        let currentUser = null;
        let typingTimeout = null;
        let isRegistering = false;
        let isDarkMode = false;
        let onlineUsers = {};

        // ========== DOM ELEMENTS ==========
        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const typingIndicator = document.getElementById('typing-indicator');
        const typingText = document.getElementById('typing-text');
        const onlineStatus = document.getElementById('online-status');
        const userCount = document.getElementById('user-count');
        const emojiPicker = document.getElementById('emoji-picker');
        const emojiGrid = document.getElementById('emoji-grid');

        // ========== EMOJI LIST ==========
        const emojis = ['ðŸ˜€','ðŸ˜ƒ','ðŸ˜„','ðŸ˜','ðŸ˜†','ðŸ˜…','ðŸ¤£','ðŸ˜‚','ðŸ™‚','ðŸ™ƒ','ðŸ˜‰','ðŸ˜Š','ðŸ˜‡','ðŸ¥°','ðŸ˜','ðŸ¤©','ðŸ˜˜','ðŸ˜—','â˜ºï¸','ðŸ˜š','ðŸ˜™','ðŸ¥²','ðŸ˜‹','ðŸ˜›','ðŸ˜œ','ðŸ¤ª','ðŸ˜','ðŸ¤‘','ðŸ¤—','ðŸ¤­','ðŸ¤«','ðŸ¤”','ðŸ¤','ðŸ¤¨','ðŸ˜','ðŸ˜‘','ðŸ˜¶','ðŸ˜','ðŸ˜’','ðŸ™„','ðŸ˜¬','ðŸ¤¥','ðŸ˜Œ','ðŸ˜”','ðŸ˜ª','ðŸ¤¤','ðŸ˜´','ðŸ˜·','ðŸ¤’','ðŸ¤•','ðŸ¤¢','ðŸ¤®','ðŸ¤§','ðŸ¥µ','ðŸ¥¶','ðŸ˜µ','ðŸ¤¯','ðŸ¥³','ðŸ˜Ž','ðŸ¤“','ðŸ§','ðŸ˜•','ðŸ˜Ÿ','ðŸ™','â˜¹ï¸','ðŸ˜®','ðŸ˜¯','ðŸ˜²','ðŸ˜³','ðŸ¥º','ðŸ˜¦','ðŸ˜§','ðŸ˜¨','ðŸ˜°','ðŸ˜¥','ðŸ˜¢','ðŸ˜­','ðŸ˜±','ðŸ˜–','ðŸ˜£','ðŸ˜ž','ðŸ˜“','ðŸ˜©','ðŸ˜«','ðŸ¥±','ðŸ˜¤','ðŸ˜¡','ðŸ˜ ','ðŸ¤¬','ðŸ‘','ðŸ‘Ž','ðŸ‘‹','ðŸ¤š','âœ‹','ðŸ––','ðŸ‘Œ','ðŸ¤Œ','ðŸ¤','âœŒï¸','ðŸ¤ž','ðŸ¤Ÿ','ðŸ¤˜','ðŸ¤™','ðŸ‘ˆ','ðŸ‘‰','ðŸ‘†','ðŸ–•','ðŸ‘‡','â˜ï¸','ðŸ‘','ðŸ™Œ','ðŸ‘','ðŸ¤²','ðŸ¤','ðŸ™','âœï¸','ðŸ’…','ðŸ¤³','ðŸ’ª','ðŸ¦¾','ðŸ¦¿','ðŸ¦µ','ðŸ¦¶','ðŸ‘‚','ðŸ¦»','ðŸ‘ƒ','ðŸ§ ','ðŸ«€','ðŸ«','ðŸ¦·','ðŸ¦´','ðŸ‘€','ðŸ‘ï¸','ðŸ‘…','ðŸ‘„','ðŸ’‹'];

        // ========== INITIALIZATION ==========
        function init() {
            initEmojiPicker();
            loadDarkMode();
            setupAuthListener();
        }

        function initEmojiPicker() {
            emojis.forEach(emoji => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'emoji-btn';
                btn.textContent = emoji;
                btn.onclick = () => {
                    messageInput.value += emoji;
                    messageInput.focus();
                    emojiPicker.classList.add('hidden');
                };
                emojiGrid.appendChild(btn);
            });
        }

        // ========== AUTHENTICATION ==========
        function toggleAuthForm() {
            isRegistering = !isRegistering;
            const authButton = document.getElementById('auth-button');
            const switchAuth = document.getElementById('switch-auth');
            const registerFields = document.getElementById('register-fields');
            const loginFields = document.getElementById('login-fields');
            const resetPassword = document.getElementById('reset-password');

            if (isRegistering) {
                authButton.textContent = 'Create Account';
                authButton.onclick = register;
                switchAuth.textContent = 'Sign in instead';
                registerFields.classList.remove('hidden');
                resetPassword.classList.add('hidden');
            } else {
                authButton.textContent = 'Sign In';
                authButton.onclick = login;
                switchAuth.textContent = 'Create an account';
                registerFields.classList.add('hidden');
                resetPassword.classList.remove('hidden');
            }
        }

        async function login() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showError('Please enter both email and password');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                showError(error.message);
            }
        }

        async function register() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value.trim();

            if (!email || !password || !username) {
                showError('Please fill in all fields');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await database.ref('users/' + userCredential.user.uid).set({
                    username: username,
                    email: email,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
            } catch (error) {
                showError(error.message);
            }
        }

        async function resetPassword() {
            const email = document.getElementById('email').value.trim();
            
            if (!email) {
                showError('Please enter your email address');
                return;
            }

            try {
                await auth.sendPasswordResetEmail(email);
                showMessage('Password reset email sent! Check your inbox.', 'success');
            } catch (error) {
                showError(error.message);
            }
        }

        async function logout() {
            if (currentUser) {
                await database.ref('online/' + currentUser.uid).remove();
                await database.ref('typing/' + currentUser.uid).remove();
            }
            await auth.signOut();
        }

        function setupAuthListener() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    showChat();
                    setupUserPresence();
                    loadMessages();
                    setupTypingListener();
                    loadUserProfile();
                } else {
                    currentUser = null;
                    showLogin();
                }
            });
        }

        async function loadUserProfile() {
            if (!currentUser) return;
            
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('app-title-header').textContent = `ChatConnect â€¢ ${userData.username}`;
                }
            });
        }

        // ========== CHAT FUNCTIONS ==========
        function setupUserPresence() {
            if (!currentUser) return;

            const userStatusRef = database.ref('online/' + currentUser.uid);
            
            // Get username first
            database.ref('users/' + currentUser.uid + '/username').once('value')
                .then((snapshot) => {
                    const username = snapshot.val() || 'User';
                    
                    userStatusRef.set({
                        username: username,
                        uid: currentUser.uid,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP,
                        online: true
                    });

                    userStatusRef.onDisconnect().remove();

                    // Listen for online users
                    database.ref('online').on('value', (snapshot) => {
                        const users = snapshot.val() || {};
                        onlineUsers = users;
                        const onlineCount = Object.keys(users).length;
                        
                        userCount.textContent = `â€¢ ${onlineCount} online`;
                        updateTypingIndicator();
                    });
                });
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            
            if (!message || !currentUser) return;

            // Clear typing status
            if (currentUser) {
                database.ref('typing/' + currentUser.uid).remove();
            }

            // Get username
            database.ref('users/' + currentUser.uid + '/username').once('value')
                .then((snapshot) => {
                    const username = snapshot.val() || 'You';
                    
                    return database.ref('messages').push().set({
                        text: message,
                        senderId: currentUser.uid,
                        senderName: username,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        seen: false
                    });
                })
                .then(() => {
                    messageInput.value = '';
                    messageInput.focus();
                })
                .catch((error) => {
                    console.error('Error sending message:', error);
                });
        }

        function loadMessages() {
            const messagesRef = database.ref('messages').limitToLast(50);
            
            messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayMessage(message, snapshot.key);
                
                // Mark as seen if not your message
                if (message.senderId !== currentUser.uid && !message.seen) {
                    database.ref('messages/' + snapshot.key + '/seen').set(true);
                }
            });
        }

        function displayMessage(message, messageId) {
            if (document.getElementById(messageId)) return;

            const isCurrentUser = message.senderId === currentUser.uid;
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `message-animation flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${isCurrentUser ? 'user' : 'other'}`;

            // Sender name (only for other users)
            if (!isCurrentUser) {
                const senderName = document.createElement('div');
                senderName.className = 'message-sender';
                senderName.textContent = message.senderName;
                bubble.appendChild(senderName);
            }

            // Message text
            const messageText = document.createElement('div');
            messageText.className = 'text-sm break-words';
            messageText.textContent = message.text;
            bubble.appendChild(messageText);

            // Timestamp
            const time = document.createElement('div');
            time.className = 'message-time';
            const date = new Date(message.timestamp);
            time.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Seen status for user's messages
            if (isCurrentUser && message.seen) {
                const seenIcon = document.createElement('span');
                seenIcon.className = 'ml-1';
                seenIcon.textContent = 'âœ“âœ“';
                time.appendChild(seenIcon);
            }
            
            bubble.appendChild(time);
            messageDiv.appendChild(bubble);

            // Clear welcome message
            const welcomeMsg = messagesContainer.querySelector('.text-center');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ========== TYPING INDICATOR ==========
        function handleTyping() {
            if (!currentUser) return;
            
            const typingRef = database.ref('typing/' + currentUser.uid);
            typingRef.set({
                uid: currentUser.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                typingRef.remove();
            }, 2000);
        }

        function setupTypingListener() {
            database.ref('typing').on('child_added', (snapshot) => {
                if (snapshot.key !== currentUser.uid) {
                    const typingData = snapshot.val();
                    const user = onlineUsers[snapshot.key];
                    
                    if (user) {
                        typingText.textContent = `${user.username} is typing...`;
                        typingIndicator.classList.remove('hidden');
                    }
                }
            });
            
            database.ref('typing').on('child_removed', () => {
                typingIndicator.classList.add('hidden');
            });
        }

        function updateTypingIndicator() {
            // Check if any user is typing
            let typingUser = null;
            database.ref('typing').once('value').then((snapshot) => {
                const typingUsers = snapshot.val() || {};
                
                for (const [uid, data] of Object.entries(typingUsers)) {
                    if (uid !== currentUser.uid && onlineUsers[uid]) {
                        typingUser = onlineUsers[uid];
                        break;
                    }
                }
                
                if (typingUser) {
                    typingText.textContent = `${typingUser.username} is typing...`;
                    typingIndicator.classList.remove('hidden');
                } else {
                    typingIndicator.classList.add('hidden');
                }
            });
        }

        // ========== UI FUNCTIONS ==========
        function showLogin() {
            loginScreen.classList.remove('hidden');
            chatScreen.classList.add('hidden');
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('username').value = '';
        }

        function showChat() {
            loginScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            messageInput.focus();
            
            // Add welcome message
            addSystemMessage('Welcome to ChatConnect! Start messaging with friends.');
        }

        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-animation flex justify-center';
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble system';
            bubble.textContent = text;
            
            messageDiv.appendChild(bubble);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function toggleEmojiPicker() {
            emojiPicker.classList.toggle('hidden');
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            document.getElementById('theme-icon').textContent = isDarkMode ? 'â˜€ï¸' : 'ðŸŒ™';
            localStorage.setItem('darkMode', isDarkMode);
        }

        function loadDarkMode() {
            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            if (savedDarkMode) {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                document.getElementById('theme-icon').textContent = 'â˜€ï¸';
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg z-50';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' : 
                'bg-blue-100 border border-blue-400 text-blue-700'
            }`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Close emoji picker when clicking outside
        document.addEventListener('click', (event) => {
            if (!event.target.closest('#emoji-toggle') && !event.target.closest('#emoji-picker')) {
                emojiPicker.classList.add('hidden');
            }
        });

        // Enter key to send message
        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        // Initialize
        init();
    </script>
</body>
</html>
